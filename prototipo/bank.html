<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmos Bank - Enterprise System v4.0</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --space-dark: #050510;
            --space-light: #1a1a2e;
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --glass-bg: rgba(20, 20, 40, 0.7);
            --glass-border: rgba(0, 243, 255, 0.2);
            --text-main: #e0e6ed;
            --success: #00ff9d;
            --danger: #ff4757;
            --warning: #ffbd00;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Rajdhani', sans-serif; }
        
        body { 
            background: radial-gradient(circle at center, #0f0c29, #302b63, #24243e); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
        }

        /* --- LAYOUT --- */
        #app { display: flex; height: 100%; }
        
        aside { 
            width: 260px; 
            background: rgba(0,0,0,0.5); 
            border-right: 1px solid var(--glass-border); 
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column; 
        }
        
        .brand { 
            padding: 30px; 
            font-family: 'Orbitron', sans-serif; 
            font-size: 1.6rem; 
            color: var(--neon-blue); 
            text-shadow: 0 0 15px rgba(0, 243, 255, 0.4);
            border-bottom: 1px solid var(--glass-border); 
            text-align: center;
        }
        
        nav button {
            width: 100%; text-align: left; padding: 18px 25px; background: none; border: none;
            color: #8892b0; cursor: pointer; transition: 0.3s; font-size: 1.1rem; font-weight: 600;
            border-left: 3px solid transparent;
        }
        nav button:hover, nav button.active { 
            background: linear-gradient(90deg, rgba(0, 243, 255, 0.1), transparent); 
            color: var(--neon-blue); 
            border-left: 3px solid var(--neon-blue); 
        }
        
        main { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        
        /* --- UI COMPONENTS --- */
        .view-section { display: none; animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        .view-section.active { display: block; }

        .card { 
            background: var(--glass-bg); 
            border: 1px solid var(--glass-border); 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
        }

        .tab-menu { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: #888; padding: 8px 15px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: 0.3s; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: var(--neon-blue); border-bottom: 2px solid var(--neon-blue); text-shadow: 0 0 8px var(--neon-blue); }

        h2 { margin-bottom: 15px; color: var(--neon-blue); font-family: 'Orbitron', sans-serif; letter-spacing: 1px; }
        h3 { margin-bottom: 15px; font-size: 1.2rem; color: #fff; border-bottom: 1px solid #333; padding-bottom: 5px; }

        input, select { 
            width: 100%; padding: 10px; background: rgba(0,0,0,0.4); 
            border: 1px solid #444; color: white; border-radius: 4px; margin-bottom: 10px; 
        }
        input:focus { outline: none; border-color: var(--neon-blue); }

        .btn { padding: 10px 20px; border-radius: 4px; border: none; cursor: pointer; font-weight: 700; transition: 0.3s; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px; }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(45deg, #00f3ff, #0066ff); color: #000; box-shadow: 0 0 10px rgba(0, 243, 255, 0.3); }
        .btn-danger { background: linear-gradient(45deg, #ff4757, #ff0000); color: white; }
        .btn-success { background: linear-gradient(45deg, #00ff9d, #00b894); color: #000; }
        .btn-warning { background: linear-gradient(45deg, #ffbd00, #ff9f43); color: #000; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }

        /* --- VISUAL TERMINALS --- */
        .lobby-container { display: flex; justify-content: center; gap: 30px; padding: 40px 0; align-items: flex-end; flex-wrap: wrap; }
        .machine { 
            width: 130px; height: 220px; background: #151515; border-radius: 10px 10px 0 0; 
            border: 2px solid #333; position: relative; cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; padding-top: 20px;
        }
        .machine:hover { transform: translateY(-10px); box-shadow: 0 0 25px var(--neon-blue); border-color: var(--neon-blue); }
        .machine .screen { width: 100px; height: 70px; background: #000; border: 1px solid #444; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; color: var(--neon-blue); font-size: 0.8rem; font-family: monospace; animation: pulse 2s infinite; }
        .machine .slot { width: 70px; height: 12px; background: #000; border: 1px solid #333; border-radius: 6px; }
        .machine-label { margin-top: 15px; font-weight: bold; color: #666; font-size: 0.9rem; }
        
        .machine.human { width: 180px; height: 240px; border-color: var(--neon-purple); }
        .machine.human:hover { box-shadow: 0 0 25px var(--neon-purple); border-color: var(--neon-purple); }
        .machine.human .screen { color: var(--neon-purple); }

        /* --- GAVETAS --- */
        .drawer-row { display: grid; grid-template-columns: 0.5fr 1fr 1fr 1fr; gap: 5px; align-items: center; margin-bottom: 8px; background: rgba(255,255,255,0.03); padding: 8px; border-radius: 4px; }
        .drawer-row small { color: #888; font-size: 0.7rem; }
        .capacity-bar { height: 4px; background: #333; border-radius: 2px; width: 100%; margin-top: 2px; overflow: hidden; }
        .cap-fill { height: 100%; transition: width 0.3s; }

        /* --- ADMIN LOGIN --- */
        #admin-lock-screen { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 10; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .lock-pad { width: 300px; padding: 30px; border: 1px solid var(--neon-blue); border-radius: 10px; text-align: center; box-shadow: 0 0 50px rgba(0, 243, 255, 0.1); }

        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; } 100% { opacity: 0.8; } }
    </style>
</head>
<body>

    <div id="app">
        <aside>
            <div class="brand"><i class="fas fa-meteor"></i> COSMOS</div>
            <nav>
                <button onclick="Router.go('hub')" class="active"><i class="fas fa-home"></i> Visão Geral</button>
                <button onclick="Router.go('agencia')"><i class="fas fa-user-shield"></i> Gerência & Tesouraria</button>
                <button onclick="Router.go('atendimento')"><i class="fas fa-money-bill-wave"></i> Autoatendimento</button>
                <button onclick="Router.go('internetbanking')"><i class="fas fa-laptop-code"></i> Internet Banking</button>
            </nav>
        </aside>

        <main>
            <!-- 0. HUB -->
            <section id="view-hub" class="view-section active">
                <h1>Painel de Controle</h1>
                <p style="color: #888;">Selecione o módulo de operação.</p>
                <div class="grid-2" style="margin-top: 30px;">
                    <div class="card" onclick="Router.go('internetbanking')" style="cursor: pointer; border-left: 4px solid var(--neon-blue);">
                        <h3><i class="fas fa-mobile-alt"></i> App Cliente</h3>
                        <p>Acesse sua conta digital.</p>
                    </div>
                    <div class="card" onclick="Router.go('atendimento')" style="cursor: pointer; border-left: 4px solid var(--neon-purple);">
                        <h3><i class="fas fa-store"></i> Ir à Agência</h3>
                        <p>Caixa Eletrônico e Presencial.</p>
                    </div>
                </div>
            </section>

            <!-- 1. AGÊNCIA (GERENCIAL - PROTEGIDO) -->
            <section id="view-agencia" class="view-section" style="position: relative; min-height: 100%;">
                
                <!-- TELA DE LOGIN ADMIN -->
                <div id="admin-lock-screen">
                    <div class="lock-pad">
                        <i class="fas fa-lock fa-3x" style="color: var(--neon-blue); margin-bottom: 20px;"></i>
                        <h3 style="border:none;">Acesso Restrito</h3>
                        <input type="text" id="admin-user" placeholder="Usuário">
                        <input type="password" id="admin-pass" placeholder="Senha">
                        <button class="btn btn-primary" style="width: 100%;" onclick="AdminAuth.login()">Desbloquear</button>
                        <p id="admin-error" style="color: var(--danger); margin-top: 10px; font-size: 0.9rem;"></p>
                    </div>
                </div>

                <!-- CONTEÚDO ADMIN -->
                <div id="admin-content" style="display: none;">
                    <div class="header-split" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>Gerência da Agência</h2>
                        <button class="btn btn-danger" onclick="AdminAuth.logout()">Bloquear <i class="fas fa-lock"></i></button>
                    </div>

                    <div class="tab-menu">
                        <button class="tab-btn active" onclick="Tabs.show('resumo')">Resumo</button>
                        <button class="tab-btn" onclick="Tabs.show('atms')">Gestão de ATMs</button>
                        <button class="tab-btn" onclick="Tabs.show('caixa')">Gestão de Caixa</button>
                        <button class="tab-btn" onclick="Tabs.show('contas')">Clientes</button>
                    </div>

                    <!-- TAB: RESUMO -->
                    <div id="tab-resumo">
                        <div class="card">
                            <div class="grid-4" style="text-align: center;">
                                <div><small>Saldo Total Sistema</small><h2 id="adm-total">R$ --</h2></div>
                                <div><small>Tesouraria (Cofre)</small><h3 id="adm-cofre" style="color: var(--warning)">R$ --</h3></div>
                                <div><small>Em Terminais (ATMs)</small><h3 id="adm-atms" style="color: var(--neon-blue)">R$ --</h3></div>
                                <div><small>No Caixa Humano</small><h3 id="adm-caixa-val" style="color: var(--neon-purple)">R$ --</h3></div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: GESTÃO ATms -->
                    <div id="tab-atms" style="display: none;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <h3>Terminais de Autoatendimento</h3>
                            <button class="btn btn-primary" onclick="AgenciaManager.calculateDynamic()"><i class="fas fa-magic"></i> Calcular Distribuição Dinâmica</button>
                        </div>
                        <div id="terminals-grid">
                            <!-- JS Renders ATMs here -->
                        </div>
                    </div>

                    <!-- TAB: GESTÃO CAIXA HUMANO -->
                    <div id="tab-caixa" style="display: none;">
                        <div class="card">
                            <h3><i class="fas fa-user-tie"></i> Controle do Caixa Humano</h3>
                            <div class="grid-2">
                                <div>
                                    <h1 id="human-cash-balance" style="color: var(--neon-purple); font-size: 3rem;">R$ 0,00</h1>
                                    <p style="color: #888;">Saldo físico atual na gaveta do caixa.</p>
                                </div>
                                <div>
                                    <h4>Operações de Numerário</h4>
                                    <input type="number" id="human-op-val" placeholder="Valor (R$)">
                                    <div class="grid-2">
                                        <button class="btn btn-success" onclick="AgenciaManager.humanRefill()"><i class="fas fa-arrow-down"></i> Abastecer (Cofre->Caixa)</button>
                                        <button class="btn btn-warning" onclick="AgenciaManager.humanRelieve()"><i class="fas fa-arrow-up"></i> Alívio (Caixa->Cofre)</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TAB: CLIENTES -->
                    <div id="tab-contas" style="display: none;">
                         <div class="card">
                            <h3>Contas Ativas</h3>
                            <table style="width: 100%; color: #ccc;">
                                <thead><tr style="text-align:left"><th>Conta</th><th>Nome</th><th>Saldo</th><th>Senhas (Web/Trans)</th></tr></thead>
                                <tbody id="accounts-list"></tbody>
                            </table>
                         </div>
                    </div>
                </div>
            </section>

            <!-- 2. ATENDIMENTO (CLIENTE - PRIVADO) -->
            <section id="view-atendimento" class="view-section">
                <h2>Lobby de Atendimento</h2>
                
                <div class="lobby-container" id="lobby-select">
                    <!-- Caixa Humano -->
                    <div class="machine human" onclick="AtendimentoManager.openTerminal('caixa')">
                        <div class="screen"><i class="fas fa-user-tie fa-2x"></i></div>
                        <div class="slot"></div>
                        <div class="machine-label">Caixa Presencial</div>
                    </div>
                    <!-- ATMs -->
                    <div class="machine" onclick="AtendimentoManager.openTerminal('atmA')">
                        <div class="screen">ATM A</div>
                        <div class="slot" style="border-color: var(--neon-blue)"></div>
                        <div class="machine-label">Terminal A</div>
                    </div>
                    <div class="machine" onclick="AtendimentoManager.openTerminal('atmB')">
                        <div class="screen">ATM B</div>
                        <div class="slot" style="border-color: var(--neon-blue)"></div>
                        <div class="machine-label">Terminal B</div>
                    </div>
                    <div class="machine" onclick="AtendimentoManager.openTerminal('atmC')">
                        <div class="screen">ATM C</div>
                        <div class="slot" style="border-color: #888"></div>
                        <div class="machine-label">Terminal C</div>
                    </div>
                    <div class="machine" onclick="AtendimentoManager.openTerminal('atmD')">
                        <div class="screen">ATM D</div>
                        <div class="slot" style="border-color: #888"></div>
                        <div class="machine-label">Terminal D</div>
                    </div>
                </div>

                <!-- MONITOR (Sem dados de Hardware) -->
                <div id="terminal-interface" style="display: none; max-width: 500px; margin: 0 auto;">
                    <div class="card" style="border: 2px solid var(--neon-blue); box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);">
                        <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 20px;">
                            <h3 id="term-title" style="border:none; margin:0; color: var(--neon-blue);">TERMINAL --</h3>
                            <button class="btn btn-danger" style="padding: 5px 10px;" onclick="AtendimentoManager.closeTerminal()">Sair</button>
                        </div>
                        
                        <div>
                            <p style="text-align:center; margin-bottom:15px; color: var(--success); font-family: monospace;">● SISTEMA ONLINE</p>
                            
                            <input type="number" id="op-conta" placeholder="Número da Conta">
                            <input type="password" id="op-senha" placeholder="Senha Transação (4 dígitos)">
                            
                            <hr style="border-color: #333; margin: 15px 0;">
                            
                            <label style="color:#888; font-size:0.8rem;">Operação</label>
                            <select id="op-type">
                                <option value="saque">Saque</option>
                                <option value="deposito">Depósito</option>
                                <option value="transferencia">Transferência</option>
                                <option value="pagamento">Pagamento</option>
                            </select>
                            
                            <input type="number" id="op-valor" placeholder="Valor R$">
                            <input type="number" id="op-dest" placeholder="Conta Destino" style="display:none">
                            
                            <button class="btn btn-success" style="width: 100%; margin-top: 15px; height: 50px; font-size: 1.1rem;" onclick="AtendimentoManager.execute()">CONFIRMAR</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. INTERNET BANKING (COMPLETO) -->
            <section id="view-internetbanking" class="view-section">
                <!-- Login -->
                <div id="ib-login-screen" style="max-width: 400px; margin: 50px auto; text-align: center;">
                    <h2 style="color: var(--neon-blue);">Cosmos Digital</h2>
                    <div class="card">
                        <input type="number" id="ib-user" placeholder="Conta">
                        <input type="password" id="ib-pass" placeholder="Senha Web">
                        <button class="btn btn-primary" style="width:100%" onclick="IBManager.login()">Acessar Conta</button>
                    </div>
                </div>

                <!-- Dashboard -->
                <div id="ib-dashboard" style="display: none;">
                    <!-- Header -->
                    <div class="card" style="background: linear-gradient(90deg, #000428, #004e92); border: 1px solid var(--neon-blue);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h2 style="margin:0; color: #fff;" id="ib-welcome">Olá</h2>
                                <h1 style="margin:0; color: var(--neon-blue);" id="ib-balance">R$ --</h1>
                            </div>
                            <button onclick="IBManager.logout()" class="btn btn-danger">Sair</button>
                        </div>
                    </div>

                    <!-- Ações Rápidas -->
                    <div class="grid-4">
                        <button class="card btn" style="text-align:center; height:auto; color:white;" onclick="IBManager.showAction('extrato')">
                            <i class="fas fa-list fa-2x" style="margin-bottom:10px; color:var(--warning)"></i><br>Extrato
                        </button>
                        <button class="card btn" style="text-align:center; height:auto; color:white;" onclick="IBManager.showAction('pix')">
                            <i class="fas fa-random fa-2x" style="margin-bottom:10px; color:var(--success)"></i><br>Pix / Transf.
                        </button>
                        <button class="card btn" style="text-align:center; height:auto; color:white;" onclick="IBManager.showAction('pagar')">
                            <i class="fas fa-barcode fa-2x" style="margin-bottom:10px; color:var(--neon-blue)"></i><br>Pagamentos
                        </button>
                    </div>

                    <!-- Painéis de Ação -->
                    <div id="ib-action-area">
                        <!-- Renderizado via JS -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        /**
         * Reescrita completa do JS: IndexedDB-backed, mantendo IDs e classes originais.
         * Funcionalidades implementadas:
         * - IndexedDB persistente (stores: config, treasuries, atms, accounts, txs, investments, armored)
         * - AdminAuth reads credenciais a partir da store config.admin (seed default 'cosmos'/'0099')
         * - AgenciaManager: distribuição, ATMs, cofres, caixa humano
         * - AtendimentoManager: operacional nos terminais (saque/dep/transfer/pagamento), log de transações
         * - IBManager: login, extrato, pix, pagamentos, investimentos simulados
         *
         * Mantive IDs/classes do HTML tal qual você exigiu.
         */

        /* ---------- IndexedDB helper ---------- */
        const IDB_NAME = 'cosmos_bank_v4';
        const IDB_VERSION = 1;
        let IDB = null;

        function idbOpen() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(IDB_NAME, IDB_VERSION);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if(!db.objectStoreNames.contains('config')) db.createObjectStore('config', {keyPath:'id'});
                    if(!db.objectStoreNames.contains('treasury')) db.createObjectStore('treasury', {keyPath:'id'});
                    if(!db.objectStoreNames.contains('atms')) db.createObjectStore('atms', {keyPath:'id'});
                    if(!db.objectStoreNames.contains('accounts')) db.createObjectStore('accounts', {keyPath:'id'});
                    if(!db.objectStoreNames.contains('transactions')) {
                        const s = db.createObjectStore('transactions',{keyPath:'id', autoIncrement:true});
                        s.createIndex('byAccount','accountId',{});
                        s.createIndex('byTime','createdAt',{});
                    }
                    if(!db.objectStoreNames.contains('investments')) db.createObjectStore('investments', {keyPath:'id', autoIncrement:true});
                    if(!db.objectStoreNames.contains('armored')) db.createObjectStore('armored', {keyPath:'id', autoIncrement:true});
                };
                req.onsuccess = e => { IDB = e.target.result; resolve(IDB); };
                req.onerror = e => reject(e);
            });
        }

        function idbTx(storeNames, mode='readonly') {
            return IDB.transaction(storeNames, mode);
        }
        function idbGet(store, key) {
            return new Promise((res, rej) => {
                const t = idbTx([store]);
                const s = t.objectStore(store);
                const r = s.get(key);
                r.onsuccess = ()=>res(r.result);
                r.onerror = ()=>rej(r.error);
            });
        }
        function idbPut(store, obj) {
            return new Promise((res, rej) => {
                const t = idbTx([store], 'readwrite');
                const s = t.objectStore(store);
                const r = s.put(obj);
                r.onsuccess = ()=>res(r.result);
                r.onerror = ()=>rej(r.error);
            });
        }
        function idbAdd(store, obj) {
            return new Promise((res, rej) => {
                const t = idbTx([store], 'readwrite');
                const s = t.objectStore(store);
                const r = s.add(obj);
                r.onsuccess = ()=>res(r.result);
                r.onerror = ()=>rej(r.error);
            });
        }
        function idbGetAll(store) {
            return new Promise((res, rej) => {
                const t = idbTx([store]);
                const s = t.objectStore(store);
                const r = s.getAll();
                r.onsuccess = ()=>res(r.result);
                r.onerror = ()=>rej(r.error);
            });
        }
        function idbClear(store) {
            return new Promise((res, rej) => {
                const t = idbTx([store], 'readwrite');
                const s = t.objectStore(store);
                const r = s.clear();
                r.onsuccess = ()=>res();
                r.onerror = ()=>rej(r.error);
            });
        }

        /* ---------- Seed ---------- */
        async function seedData() {
            // config/admin
            await idbPut('config', {id:'admin', user:'cosmos', pass:'0099'} );
            // system config
            await idbPut('config', {id:'system', totalCash: 500000000}); // cents (R$5.000.000)
            // treasury: cofres A/B and human cashier reserve limit
            await idbPut('treasury', {id:'vaults', cofreA:125000000, cofreB:125000000, humanCash:1000000}); // in cents; humanCash here is what can be kept overnight? we'll track real humanCash separately
            // create ATMs (A,B: drawers limit 3000 notes each, C,D: 1800)
            const defaultFaces = [1000,2000,5000,10000]; // in cents: 10,20,50,100
            await idbPut('atms', {id:'atmA', drawers: [
                {face: defaultFaces[0], count: 3000, max:3000},
                {face: defaultFaces[1], count: 3000, max:3000},
                {face: defaultFaces[2], count: 3000, max:3000},
                {face: defaultFaces[3], count: 3000, max:3000},
                {face: 0, count:0, max:3000} // fifth drawer
            ], percent:31});
            await idbPut('atms', {id:'atmB', drawers: [
                {face: defaultFaces[0], count: 3000, max:3000},
                {face: defaultFaces[1], count: 3000, max:3000},
                {face: defaultFaces[2], count: 3000, max:3000},
                {face: defaultFaces[3], count: 3000, max:3000},
                {face: 0, count:0, max:3000}
            ], percent:31});
            await idbPut('atms', {id:'atmC', drawers: [
                {face: defaultFaces[0], count: 1800, max:1800},
                {face: defaultFaces[1], count: 1800, max:1800},
                {face: defaultFaces[2], count: 1800, max:1800},
                {face: defaultFaces[3], count: 1800, max:1800},
                {face: 0, count:0, max:1800}
            ], percent:19});
            await idbPut('atms', {id:'atmD', drawers: [
                {face: defaultFaces[0], count: 1800, max:1800},
                {face: defaultFaces[1], count: 1800, max:1800},
                {face: defaultFaces[2], count: 1800, max:1800},
                {face: defaultFaces[3], count: 1800, max:1800},
                {face: 0, count:0, max:1800}
            ], percent:19});
            // accounts sample
            await idbPut('accounts', {id:1, name:'Elon Musk', balance:1000000, pw:'123', pt:'1234', hist:[]});
            await idbPut('accounts', {id:2, name:'Jeff Bezos', balance:500000, pw:'123', pt:'1234', hist:[]});
            await idbPut('accounts', {id:3, name:'Bill Gates', balance:250000, pw:'123', pt:'1234', hist:[]});
            // clear txs/investments/armored
            await idbClear('transactions'); await idbClear('investments'); await idbClear('armored');
        }

        /* ---------- Helpers ---------- */
        function nowISO(){ return new Date().toISOString(); }
        function centsToMoney(c){ return (c/100).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}); }
        function moneyToCents(v){ return Math.round(parseFloat(v||0)*100); }

        /* ---------- Admin Auth ---------- */
        const AdminAuth = {
            isLoggedIn: false,
            async login() {
                const u = document.getElementById('admin-user').value;
                const p = document.getElementById('admin-pass').value;
                const cfg = await idbGet('config', 'admin');
                if(cfg && u === cfg.user && p === cfg.pass) {
                    this.isLoggedIn = true;
                    document.getElementById('admin-lock-screen').style.display = 'none';
                    document.getElementById('admin-content').style.display = 'block';
                    await AgenciaManager.init();
                } else {
                    document.getElementById('admin-error').innerText = "Acesso Negado. Tentativa registrada.";
                    // register armored attempt for audit
                    await idbAdd('armored', {type:'admin_fail', composition: `${u} / ${p}`, createdAt: nowISO()});
                }
            },
            logout() {
                this.isLoggedIn = false;
                document.getElementById('admin-lock-screen').style.display = 'flex';
                document.getElementById('admin-content').style.display = 'none';
                document.getElementById('admin-pass').value = '';
            }
        };

        /* ---------- Agencia Manager (Tesouraria / ATMs) ---------- */
        const AgenciaManager = {
            async init() {
                // refresh summary & render atms & accounts
                await this.updateSummary();
                await this.renderATMs();
                await this.renderAccounts();
            },

            async getAllATMs() {
                const all = await idbGetAll('atms');
                // convert to object keyed by id for convenience
                const obj = {};
                all.forEach(a=>obj[a.id] = a);
                return obj;
            },

            async getAtmTotal(atm) {
                if(!atm) return 0;
                return atm.drawers.reduce((acc, d) => acc + (d.face * d.count), 0);
            },

            async updateSummary() {
                const system = await idbGet('config','system');
                const vaults = await idbGet('treasury','vaults');
                const atmsArr = await idbGetAll('atms');
                let atmTotal = 0;
                for(const a of atmsArr) atmTotal += await this.getAtmTotal(a);
                const human = vaults ? vaults.humanCash : 0;
                const totalSys = (vaults ? (vaults.cofreA + vaults.cofreB) : 0) + human + atmTotal;
                document.getElementById('adm-total').innerText = `R$ ${centsToMoney(totalSys)}`;
                document.getElementById('adm-cofre').innerText = `R$ ${centsToMoney((vaults?.cofreA||0) + (vaults?.cofreB||0))}`;
                document.getElementById('adm-atms').innerText = `R$ ${centsToMoney(atmTotal)}`;
                document.getElementById('adm-caixa-val').innerText = `R$ ${centsToMoney(human)}`;
                document.getElementById('human-cash-balance').innerText = `R$ ${centsToMoney(human)}`;
            },

            async renderATMs() {
                const grid = document.getElementById('terminals-grid');
                const atms = await idbGetAll('atms');
                grid.innerHTML = '';
                for(const atm of atms) {
                    const total = await this.getAtmTotal(atm);
                    let html = `<div class="card" style="background:rgba(255,255,255,0.05)">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <strong style="color:var(--neon-blue)">${atm.id.toUpperCase()}</strong>
                            <span>Total Físico: R$ ${centsToMoney(total)}</span>
                        </div>`;
                    atm.drawers.forEach((d, idx) => {
                        const pct = Math.min(100, Math.round((d.count / d.max) * 100));
                        // id values keep consistent
                        html += `
                        <div class="drawer-row">
                            <input type="number" style="width:60px; margin:0;" value="${d.face===0?0:(d.face/100).toFixed(0)}" onchange="AgenciaManager.setFace('${atm.id}',${idx},this.value)">
                            <small>${d.count}/${d.max}</small>
                            <input type="number" id="in-${atm.id}-${idx}" placeholder="Qtd" style="margin:0; width:60px;">
                            <div class="capacity-bar"><div class="cap-fill" style="width:${pct}%; background:var(--neon-blue)"></div></div>
                        </div>`;
                    });
                    html += `
                    <div class="grid-2" style="margin-top:10px;">
                        <button class="btn btn-primary" onclick="AgenciaManager.atmOp('${atm.id}', 'add')">Abastecer</button>
                        <button class="btn btn-warning" onclick="AgenciaManager.atmOp('${atm.id}', 'sub')">Alívio</button>
                    </div></div>`;
                    grid.insertAdjacentHTML('beforeend', html);
                }
            },

            async setFace(id, idx, val) {
                const atm = await idbGet('atms', id);
                const v = parseInt(val||'0');
                // store faces in cents (0 if 0)
                atm.drawers[idx].face = v > 0 ? v*100 : 0;
                // alert if change creates imbalance — simple check: face=0 means generic drawer
                // push a notice into armored store (used as general audit log)
                await idbPut('atms', atm);
                await idbAdd('armored', {type:'face_change', composition:`${id} drawer ${idx+1} face ${atm.drawers[idx].face}`, createdAt: nowISO()});
                await this.renderATMs();
                await this.updateSummary();
            },

            async calculateDynamic() {
                // Strategy: use system total and percentages to compute ideal fill for each terminal,
                // then compute suggested counts per drawer based on faces and max per drawer.
                const sys = await idbGet('config','system');
                const total = sys?.totalCash || 0;
                const half = Math.floor(total/2);
                const caixaLimit = 1000000; // 10k cents
                const afterCaixa = Math.max(0, half - caixaLimit);
                const cofreEach = Math.floor(afterCaixa/2);
                // terminals pool
                const terminalPool = total - half;
                const atms = await idbGetAll('atms');
                // For each atm, compute desired amount as its percent share of terminalPool
                const suggestions = [];
                for(const atm of atms) {
                    const desired = Math.floor(terminalPool * (atm.percent/100));
                    // suggest fill per drawer: greedy largest face first
                    const suggestion = this.suggestFill(atm, desired);
                    suggestions.push(suggestion);
                }
                // show simple overlay message with results
                const msg = suggestions.map(s=>`Terminal ${s.atmId}: Sugerido R$ ${centsToMoney(s.placed)}, sobra R$ ${centsToMoney(s.remainder)}`).join('\n');
                alert('Sugestões geradas.\nRevise nos campos e clique em Abastecer.\n\n' + msg);
                // write suggestions into inputs
                for(const s of suggestions) {
                    for(let i=0;i<5;i++) {
                        const el = document.getElementById(`in-${s.atmId}-${i}`);
                        if(el) el.value = s.counts[i];
                    }
                }
            },

            suggestFill(atm, amountCents) {
                // greedy algorithm: fill largest-face first within max per drawer
                const faces = atm.drawers.map(d=>d.face || 0); // zero indicates generic
                let remaining = amountCents;
                const counts = [0,0,0,0,0];
                // allocate from largest face to smallest
                const indices = [0,1,2,3].sort((a,b)=>faces[b]-faces[a]);
                for(const i of indices) {
                    const face = faces[i];
                    if(face <= 0) continue;
                    const possible = Math.floor(remaining/face);
                    const canPlace = Math.min(possible, atm.drawers[i].max - atm.drawers[i].count);
                    counts[i] = canPlace;
                    remaining -= canPlace * face;
                }
                // fifth drawer gets remainder in smallest denomination (2 reais = 200cents)
                const minFace = 200;
                const fifthNeed = Math.ceil(remaining / minFace);
                const fifthAllowed = atm.drawers[4].max - atm.drawers[4].count;
                counts[4] = Math.min(fifthNeed, fifthAllowed);
                const placed = counts.slice(0,4).reduce((s,c,i)=> s + c * (faces[i]||0), 0) + counts[4] * minFace;
                return {atmId: atm.id, counts, placed, remainder: Math.max(0, amountCents - placed)};
            },

            async atmOp(id, mode) {
                // mode 'add' or 'sub'
                const atm = await idbGet('atms', id);
                let totalDelta = 0;
                const ops = [];
                for(let i=0;i<atm.drawers.length;i++){
                    const el = document.getElementById(`in-${id}-${i}`);
                    const qty = parseInt(el?.value || '0') || 0;
                    if(qty === 0) continue;
                    ops.push({idx:i, qty});
                    const face = atm.drawers[i].face || 0;
                    totalDelta += (face * qty);
                }
                // validation
                const vaults = await idbGet('treasury','vaults');
                if(mode === 'add') {
                    // ensure vault has enough cofreA+cofreB combined
                    const vaultTotal = (vaults?.cofreA||0) + (vaults?.cofreB||0);
                    if(totalDelta > vaultTotal) return alert('Cofre insuficiente para essa operação');
                }
                // perform ops
                for(const o of ops){
                    const d = atm.drawers[o.idx];
                    if(mode === 'add') {
                        if(d.count + o.qty > d.max) return alert(`Capacidade excedida na gaveta de face ${d.face/100 || 'gen'}`);
                        d.count += o.qty;
                        // deduct value from vaults: assume we take from cofreA then cofreB
                        let remainingValue = (d.face||200) * o.qty; // if face 0, treat as 2 reais
                        // remove from cofreA then cofreB
                        let takeA = Math.min(vaults.cofreA, remainingValue);
                        vaults.cofreA -= takeA;
                        remainingValue -= takeA;
                        if(remainingValue>0){
                            let takeB = Math.min(vaults.cofreB, remainingValue);
                            vaults.cofreB -= takeB;
                            remainingValue -= takeB;
                        }
                    } else {
                        if(d.count - o.qty < 0) return alert(`Saldo insuficiente na gaveta de face ${d.face/100 || 'gen'}`);
                        d.count -= o.qty;
                        // credit to coffers proportionally (to cofreA then cofreB)
                        const credit = (d.face||200) * o.qty;
                        // simple rule: all to cofreA
                        vaults.cofreA += credit;
                    }
                    // clear input field
                    const el = document.getElementById(`in-${id}-${o.idx}`);
                    if(el) el.value = '';
                }
                await idbPut('atms', atm);
                await idbPut('treasury', vaults);
                await idbAdd('armored', {type: mode === 'add' ? 'atm_refill' : 'atm_relieve', composition: `${id} ${JSON.stringify(ops)}`, createdAt: nowISO()});
                await this.updateSummary();
                await this.renderATMs();
                alert('Operação realizada com sucesso');
            },

            async humanRefill() {
                const v = parseFloat(document.getElementById('human-op-val').value);
                if(!v || v <= 0) return alert('Valor inválido');
                const cents = moneyToCents(v);
                const vaults = await idbGet('treasury','vaults');
                // use cofreA first
                if((vaults.cofreA + vaults.cofreB) < cents) return alert('Cofre insuficiente');
                // deduct from cofreA then cofreB
                let rem = cents;
                let takeA = Math.min(vaults.cofreA, rem);
                vaults.cofreA -= takeA; rem -= takeA;
                if(rem>0){ let takeB = Math.min(vaults.cofreB, rem); vaults.cofreB -= takeB; rem -= takeB; }
                // credit humanCash (we track human cash separately as humanCash property)
                vaults.humanCash = (vaults.humanCash||0) + cents;
                await idbPut('treasury', vaults);
                await idbAdd('armored', {type:'human_refill', composition: `R$${(cents/100).toFixed(2)}`, createdAt: nowISO()});
                await this.updateSummary();
                alert('Caixa abastecido');
            },

            async humanRelieve() {
                const v = parseFloat(document.getElementById('human-op-val').value);
                if(!v || v <= 0) return alert('Valor inválido');
                const cents = moneyToCents(v);
                const vaults = await idbGet('treasury','vaults');
                if((vaults.humanCash||0) < cents) return alert('Caixa humano não possui esse valor');
                vaults.humanCash -= cents;
                // credit to cofreA (for simplicity)
                vaults.cofreA += cents;
                await idbPut('treasury', vaults);
                await idbAdd('armored', {type:'human_relieve', composition: `R$${(cents/100).toFixed(2)}`, createdAt: nowISO()});
                await this.updateSummary();
                alert('Alívio realizado');
            },

            async renderAccounts() {
                const list = document.getElementById('accounts-list');
                const accs = await idbGetAll('accounts');
                list.innerHTML = accs.map(a => 
                    `<tr style="border-bottom:1px solid #333">
                        <td>${a.id}</td><td>${a.name}</td>
                        <td style="color:var(--success)">R$ ${centsToMoney(a.balance)}</td>
                        <td style="font-family:monospace; color:var(--warning)">Web:${a.pw} / Trans:${a.pt}</td>
                    </tr>`
                ).join('');
            }
        };

        /* ---------- Atendimento Manager (Terminais & Caixa) ---------- */
        const AtendimentoManager = {
            curr: null,
            openTerminal(id) {
                this.curr = id;
                document.getElementById('lobby-select').style.display = 'none';
                document.getElementById('terminal-interface').style.display = 'block';
                document.getElementById('term-title').innerText = id === 'caixa' ? "CAIXA HUMANO" : `TERMINAL ${id.replace('atm','')}`;
                const dest = document.getElementById('op-dest');
                const type = document.getElementById('op-type');
                dest.style.display = 'none';
                type.onchange = () => {
                     dest.style.display = (type.value === 'transferencia') ? 'block' : 'none';
                };
            },
            closeTerminal() {
                document.getElementById('lobby-select').style.display = 'flex';
                document.getElementById('terminal-interface').style.display = 'none';
            },
            async execute() {
                const id = parseInt(document.getElementById('op-conta').value || '0');
                const pt = document.getElementById('op-senha').value;
                const type = document.getElementById('op-type').value;
                const val = parseFloat(document.getElementById('op-valor').value);
                const destId = parseInt(document.getElementById('op-dest').value || '0');

                if(!val || val <= 0) return alert("Valor inválido");
                if(this.curr !== 'caixa' && !Number.isInteger(val)) return alert("Este terminal não aceita moedas/centavos. Use valores inteiros.");

                const acc = await idbGet('accounts', id);
                if(!acc || acc.pt !== pt) return alert("Autenticação inválida");

                const cents = moneyToCents(val);

                if(type === 'saque') {
                    if(acc.balance < cents) return alert("Saldo insuficiente em conta");
                    if(this.curr === 'caixa') {
                        const vaults = await idbGet('treasury','vaults');
                        if((vaults.humanCash||0) < cents) return alert("Caixa sem numerário físico suficiente.");
                        vaults.humanCash -= cents;
                        await idbPut('treasury', vaults);
                    } else {
                        const atm = await idbGet('atms', this.curr);
                        // Try to dispense using greedy approach from larger notes to smaller
                        let rem = cents;
                        // create array of [idx, face, count]
                        const drawers = atm.drawers.map((d, idx) => ({idx, face: d.face || 0, count: d.count}));
                        drawers.sort((a,b)=> b.face - a.face);
                        for(const d of drawers) {
                            if(rem <= 0) break;
                            if(d.face <= 0) continue;
                            const need = Math.min(Math.floor(rem / d.face), d.count);
                            if(need > 0) {
                                // apply update to actual atm drawers after
                                atm.drawers[d.idx].count -= need;
                                rem -= need * d.face;
                            }
                        }
                        if(rem > 0) {
                            // try fifth drawer using min face 200
                            const avail5 = atm.drawers[4].count;
                            const need5 = Math.ceil(rem / 200);
                            if(need5 <= avail5) {
                                atm.drawers[4].count -= need5;
                                rem = 0;
                            } else {
                                // rollback not necessary because we already mutated counts; instead reload seed? simpler: abort
                                alert("Impossível compor o saque com notas disponíveis");
                                // refresh atm from DB to restore state (re-read)
                                const fresh = await idbGet('atms', this.curr);
                                Object.assign(atm, fresh);
                                return;
                            }
                        }
                        await idbPut('atms', atm);
                    }
                    acc.balance -= cents;
                    acc.hist = acc.hist || [];
                    acc.hist.push({desc:`Saque ${this.curr}`, v:- (cents/100), d:new Date().toLocaleString()});
                    await idbPut('accounts', acc);
                    await idbAdd('transactions', {accountId: acc.id, type:'withdraw', amount:cents, meta:{terminal:this.curr}, createdAt: nowISO()});
                    alert("Saque realizado");
                } else if(type === 'deposito') {
                    acc.balance += cents;
                    acc.hist = acc.hist || [];
                    acc.hist.push({desc:`Depósito ${this.curr}`, v: (cents/100), d:new Date().toLocaleString()});
                    await idbPut('accounts', acc);
                    if(this.curr === 'caixa') {
                        const vaults = await idbGet('treasury','vaults');
                        vaults.humanCash = (vaults.humanCash||0) + cents;
                        await idbPut('treasury', vaults);
                    } else {
                        // deposit into atm: we expect deposit by cédula via a different UI (here we simply credit to atm drawer 4)
                        const atm = await idbGet('atms', this.curr);
                        // naive: add to drawer 4 (index 0) using face 100 if possible
                        atm.drawers[0].count += Math.floor(cents / atm.drawers[0].face || 1);
                        await idbPut('atms', atm);
                    }
                    await idbAdd('transactions', {accountId: acc.id, type:'deposit', amount:cents, meta:{terminal:this.curr}, createdAt: nowISO()});
                    alert("Depósito registrado");
                } else if(type === 'transferencia') {
                    const dest = await idbGet('accounts', destId);
                    if(!dest) return alert("Conta destino não encontrada");
                    if(acc.balance < cents) return alert("Saldo insuficiente");
                    acc.balance -= cents; dest.balance += cents;
                    acc.hist = acc.hist || []; dest.hist = dest.hist || [];
                    acc.hist.push({desc:`Transf p/${dest.id}`, v: -(cents/100), d:new Date().toLocaleString()});
                    dest.hist.push({desc:`Receb. de ${acc.id}`, v: (cents/100), d:new Date().toLocaleString()});
                    await idbPut('accounts', acc); await idbPut('accounts', dest);
                    await idbAdd('transactions', {accountId: acc.id, type:'transfer_out', amount:cents, meta:{to:dest.id}, createdAt: nowISO()});
                    await idbAdd('transactions', {accountId: dest.id, type:'transfer_in', amount:cents, meta:{from:acc.id}, createdAt: nowISO()});
                    alert("Transferência efetuada");
                } else if(type === 'pagamento') {
                    if(acc.balance < cents) return alert("Saldo insuficiente");
                    acc.balance -= cents;
                    acc.hist = acc.hist || [];
                    acc.hist.push({desc:`Pagamento`, v: -(cents/100), d:new Date().toLocaleString()});
                    await idbPut('accounts', acc);
                    await idbAdd('transactions', {accountId: acc.id, type:'payment', amount:cents, meta:{terminal:this.curr}, createdAt: nowISO()});
                    alert("Pagamento processado");
                }

                // post-exec: save and refresh UI
                await AgenciaManager.updateSummary();
            }
        };

        /* ---------- Internet Banking Manager ---------- */
        const IBManager = {
            user: null,
            async login() {
                const u = parseInt(document.getElementById('ib-user').value || '0');
                const p = document.getElementById('ib-pass').value;
                const acc = await idbGet('accounts', u);
                if(acc && acc.pw === p) {
                    this.user = acc;
                    document.getElementById('ib-login-screen').style.display='none';
                    document.getElementById('ib-dashboard').style.display='block';
                    this.updateDash();
                } else alert("Dados inválidos");
            },
            logout() { location.reload(); },

            async updateDash() {
                const acc = await idbGet('accounts', this.user.id);
                document.getElementById('ib-welcome').innerText = `Olá, ${acc.name}`;
                document.getElementById('ib-balance').innerText = `R$ ${centsToMoney(acc.balance)}`;
            },

            async showAction(act) {
                const area = document.getElementById('ib-action-area');
                area.innerHTML = '';
                
                if(act === 'extrato') {
                    const acc = await idbGet('accounts', this.user.id);
                    const txs = await new Promise((res, rej) => {
                        const t = idbTx(['transactions']);
                        const store = t.objectStore('transactions');
                        const idx = store.index('byAccount');
                        const req = idx.getAll(IDBKeyRange.only(acc.id));
                        req.onsuccess = ()=>res(req.result);
                        req.onerror = ()=>rej(req.error);
                    });
                    let html = `<div class="card"><h3>Extrato</h3><ul style="list-style:none">`;
                    if(!txs.length) html += `<li>Sem movimentos</li>`;
                    else {
                        txs.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
                        for(const r of txs) {
                            html += `<li style="border-bottom:1px solid #333; padding:8px; display:flex; justify-content:space-between">
                                <span>${new Date(r.createdAt).toLocaleString()} - ${r.type}</span>
                                <span style="color:${r.amount<0?'var(--danger)':'var(--success)'}">R$ ${(r.amount/100).toFixed(2)}</span>
                            </li>`;
                        }
                    }
                    html += `</ul></div>`;
                    area.innerHTML = html;
                } else if(act === 'pix') {
                    area.innerHTML = `
                    <div class="card">
                        <h3>Transferência / Pix</h3>
                        <input id="pix-dest" placeholder="Conta destino (número)">
                        <input id="pix-val" type="number" placeholder="Valor (R$)">
                        <button class="btn btn-primary" onclick="IBManager.execPix()">Enviar Pix</button>
                    </div>`;
                } else if(act === 'pagar') {
                    area.innerHTML = `
                    <div class="card">
                        <h3>Pagamento</h3>
                        <input id="pag-code" placeholder="Código / Descrição">
                        <input id="pag-val" type="number" placeholder="Valor (R$)">
                        <button class="btn btn-warning" onclick="IBManager.execPay()">Pagar</button>
                    </div>`;
                }
            },

            async execPix() {
                const dest = parseInt(document.getElementById('pix-dest').value || '0');
                const val = parseFloat(document.getElementById('pix-val').value);
                const cents = moneyToCents(val);
                const acc = await idbGet('accounts', this.user.id);
                if(acc.balance < cents) return alert('Saldo insuficiente');
                const destAcc = await idbGet('accounts', dest);
                acc.balance -= cents; await idbPut('accounts', acc);
                await idbAdd('transactions', {accountId: acc.id, type:'pix_out', amount: cents, meta:{to: dest}, createdAt: nowISO()});
                if(destAcc) {
                    destAcc.balance += cents; await idbPut('accounts', destAcc);
                    await idbAdd('transactions', {accountId: destAcc.id, type:'pix_in', amount: cents, meta:{from: acc.id}, createdAt: nowISO()});
                }
                await this.updateDash();
                alert('Pix enviado');
            },

            async execPay() {
                const val = parseFloat(document.getElementById('pag-val').value);
                const cents = moneyToCents(val);
                const acc = await idbGet('accounts', this.user.id);
                if(acc.balance < cents) return alert('Saldo insuficiente');
                acc.balance -= cents; await idbPut('accounts', acc);
                await idbAdd('transactions', {accountId: acc.id, type:'payment', amount: cents, meta:{code: document.getElementById('pag-code').value}, createdAt: nowISO()});
                await this.updateDash();
                alert('Pagamento realizado');
            }
        };

        /* ---------- Router & Tabs ---------- */
        const Router = {
            go(id) {
                document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
                document.getElementById('view-'+id).classList.add('active');
                // set active nav
                document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
                const btnMap = {'hub':0,'agencia':1,'atendimento':2,'internetbanking':3};
                document.querySelectorAll('nav button')[btnMap[id]].classList.add('active');
            }
        };

        const Tabs = {
            show(id) {
                document.querySelectorAll('[id^="tab-"]').forEach(e => e.style.display = 'none');
                document.getElementById('tab-'+id).style.display = 'block';
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                event.target.classList.add('active');
            }
        };

        /* ---------- Boot ---------- */
        (async function boot(){
            await idbOpen();
            // check seed: config.system exists?
            const sys = await idbGet('config','system');
            if(!sys) {
                await seedData();
            }
            // initial UI state
            Router.go('hub');
            // if admin creds present, do nothing until login
            // preload basic admin view if wanted
        })();

    </script>
</body>
</html>
